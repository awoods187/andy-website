---
import { getCollection, type CollectionEntry } from 'astro:content';
import BaseLayout from '../../../layouts/BaseLayout.astro';
import BlogPostCard from '../../../components/BlogPostCard.astro';

type BlogPost = CollectionEntry<'blog'>;

interface Props {
  posts: BlogPost[];
  tag: string;
}

export async function getStaticPaths() {
  const allPosts: BlogPost[] = await getCollection('blog');
  const publishedPosts: BlogPost[] = allPosts.filter((post: BlogPost) => !post.data.draft);

  // Get all unique tags
  const uniqueTags: string[] = [
    ...new Set(publishedPosts.flatMap((post: BlogPost) => post.data.tags)),
  ];

  return uniqueTags.map((tag: string) => {
    const filteredPosts: BlogPost[] = publishedPosts
      .filter((post: BlogPost) => post.data.tags.includes(tag))
      .sort((a: BlogPost, b: BlogPost) => b.data.date.valueOf() - a.data.date.valueOf());

    return {
      params: { tag },
      props: { posts: filteredPosts, tag },
    };
  });
}

const { posts, tag } = Astro.props;
const capitalizedTag: string = tag.charAt(0).toUpperCase() + tag.slice(1);
---

<BaseLayout
  title={`Posts tagged "${capitalizedTag}" - Andy Woods`}
  description={`All blog posts tagged with ${capitalizedTag}`}
>
  <header class="mb-12">
    <p class="text-sm text-gray-600 mb-2">
      <a href="/blog" class="hover:text-black transition-colors">‚Üê Back to all posts</a>
    </p>
    <h1 class="font-sans text-4xl font-bold mb-4 text-black">
      Posts tagged "{capitalizedTag}"
    </h1>
    <p class="text-lg text-gray-600">
      {posts.length}
      {posts.length === 1 ? 'post' : 'posts'}
    </p>
  </header>

  <div>
    {
      posts.map((post: BlogPost) => {
        return (
          <BlogPostCard
            title={post.data.title}
            date={post.data.date}
            excerpt={post.data.excerpt}
            slug={post.slug}
            tags={post.data.tags}
          />
        );
      })
    }
  </div>
</BaseLayout>
